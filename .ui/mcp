#!/bin/bash
# CRC: crc-MCPScript.md, crc-CheckpointManager.md
dir=$(dirname "$(realpath "$0")")
port=$(cat "$dir/mcp-port")
prog="$1"
shift

help() {
    cat 1>&2 <<here
usage: mcp [--help | PROG [options]]

mcp --help                      this message
mcp audit APP                   run code quality audit on APP
mcp patterns                    list available patterns with frontmatter
mcp checkpoint CMD APP [MSG]    manage app checkpoints (save/list/rollback/diff/clear/baseline/count)
mcp browser                     open browser to UI session
mcp display APP                 display APP in the browser
mcp event                       wait for next UI event (120s timeout)
mcp linkapp add|remove APP      manage app symlinks
mcp progress APP PERCENT STAGE  report build progress
mcp run 'lua code'              execute Lua code in session
mcp state                       get current session state
mcp status                      get server status
mcp theme list                  list available themes
mcp theme classes [THEME]       list semantic classes for theme
mcp theme audit APP [THEME]     audit app's theme class usage
mcp variables                   get current variable values
here
}

ensure_fossil() {
    FOSSIL_BIN="$HOME/.claude/bin/fossil"
    if [ -x "$FOSSIL_BIN" ]; then
        return 0
    fi
    echo "Downloading fossil..." >&2
    mkdir -p "$HOME/.claude/bin"

    # Get latest version from changes page
    version=$(curl -sL "https://fossil-scm.org/home/doc/trunk/www/changes.wiki" | grep -oP '(?<=<h2 id="v)[0-9]+_[0-9]+' | head -1 | tr '_' '.')
    if [ -z "$version" ]; then
        version="2.27"  # fallback
    fi

    case "$(uname -s)-$(uname -m)" in
        Linux-x86_64)
            url="https://fossil-scm.org/home/uv/fossil-linux-x64-${version}.tar.gz"
            ;;
        Darwin-arm64)
            url="https://fossil-scm.org/home/uv/fossil-mac-arm-${version}.tar.gz"
            ;;
        Darwin-x86_64)
            url="https://fossil-scm.org/home/uv/fossil-mac-x64-${version}.tar.gz"
            ;;
        *)
            echo "Unsupported platform: $(uname -s)-$(uname -m)" >&2
            exit 1
            ;;
    esac
    curl -sL "$url" | tar -xzf - -C "$HOME/.claude/bin" fossil
    chmod +x "$FOSSIL_BIN"
}

checkpoint_save() {
    local app="$1" msg="$2"
    local app_dir="$dir/apps/$app"
    local repo="$app_dir/checkpoint.fossil"

    if [ ! -d "$app_dir" ]; then
        echo "App not found: $app" >&2
        exit 1
    fi

    ensure_fossil
    cd "$app_dir"

    if [ ! -f "$repo" ]; then
        # Initialize new repo
        "$FOSSIL_BIN" init "$repo" --project-name "$app" >/dev/null
        "$FOSSIL_BIN" open "$repo" --force >/dev/null
        "$FOSSIL_BIN" settings ignore-glob '.#*,.*~,*~,checkpoint.fossil,.fslckout'
        # Add all files and create first check-in with app contents
        "$FOSSIL_BIN" add . >/dev/null 2>&1
        "$FOSSIL_BIN" commit -m "${msg:-initial state}" --no-warnings >/dev/null
        echo "Created checkpoint: ${msg:-initial state}"
        # Notify UI of checkpoint change
        "$dir/mcp" run "if appConsole then appConsole._checkpointsTime = 0 end" >/dev/null 2>&1
    else
        # Add new files and remove deleted files, then check for changes
        "$FOSSIL_BIN" addremove >/dev/null 2>&1
        if "$FOSSIL_BIN" changes --quiet | grep -q .; then
            "$FOSSIL_BIN" commit -m "${msg:-checkpoint}" --no-warnings >/dev/null
            echo "Saved checkpoint: ${msg:-checkpoint}"
            # Notify UI of checkpoint change
            "$dir/mcp" run "if appConsole then appConsole._checkpointsTime = 0 end" >/dev/null 2>&1
        else
            echo "No changes to checkpoint"
        fi
    fi
}

checkpoint_list() {
    local app="$1"
    local app_dir="$dir/apps/$app"
    local repo="$app_dir/checkpoint.fossil"

    if [ ! -f "$repo" ]; then
        echo "No checkpoints for $app"
        exit 0
    fi

    ensure_fossil
    cd "$app_dir"
    # Remove date headers, baseline, and fossil artifacts
    "$FOSSIL_BIN" timeline -t ci --oneline | head -n -3
}

checkpoint_rollback() {
    local app="$1" n="$2"
    local app_dir="$dir/apps/$app"
    local repo="$app_dir/checkpoint.fossil"

    if [ ! -f "$repo" ]; then
        echo "No checkpoints for $app" >&2
        exit 1
    fi

    ensure_fossil
    cd "$app_dir"

    if [ -z "$n" ]; then
        # Undo last change
        "$FOSSIL_BIN" undo
    else
        # Get hash of nth commit (1-indexed, excluding baseline and artifacts)
        local hash=$("$FOSSIL_BIN" timeline -n 100 -t ci --oneline | grep -v '^---\|^+++\|=== BASELINE ===' | head -n "$n" | tail -1 | cut -d' ' -f1)
        if [ -z "$hash" ]; then
            echo "Checkpoint $n not found" >&2
            exit 1
        fi
        "$FOSSIL_BIN" checkout "$hash" --force
    fi
    echo "Rolled back to checkpoint"
}

checkpoint_diff() {
    local app="$1" n="${2:-1}"
    local app_dir="$dir/apps/$app"
    local repo="$app_dir/checkpoint.fossil"

    if [ ! -f "$repo" ]; then
        echo "No checkpoints for $app" >&2
        exit 1
    fi

    ensure_fossil
    cd "$app_dir"

    # Get hash of nth commit (1-indexed, excluding baseline and artifacts)
    local hash=$("$FOSSIL_BIN" timeline -t ci --oneline | head -n -3 | head -n "$n" | tail -1 | cut -d' ' -f1)
    if [ -z "$hash" ]; then
        echo "Checkpoint $n not found" >&2
        exit 1
    fi
    "$FOSSIL_BIN" diff --from "$hash"
}

checkpoint_clear() {
    # Clear = reset to baseline (same as baseline command)
    checkpoint_baseline "$1"
}

checkpoint_baseline() {
    local app="$1"
    local app_dir="$dir/apps/$app"
    local repo="$app_dir/checkpoint.fossil"

    if [ ! -d "$app_dir" ]; then
        echo "App not found: $app" >&2
        exit 1
    fi

    ensure_fossil
    cd "$app_dir"

    # Close and remove existing repo if present
    if [ -f "$repo" ]; then
        "$FOSSIL_BIN" close --force 2>/dev/null
        rm -f "$repo" .fslckout
    fi

    # Create fresh repo with current state as baseline
    "$FOSSIL_BIN" init "$repo" --project-name "$app" >/dev/null
    "$FOSSIL_BIN" open "$repo" --force >/dev/null
    "$FOSSIL_BIN" settings ignore-glob '.#*,.*~,*~,checkpoint.fossil,.fslckout'
    "$FOSSIL_BIN" add . >/dev/null 2>&1
    "$FOSSIL_BIN" commit -m "=== BASELINE ===" --no-warnings >/dev/null
    echo "Baseline set for $app"
    # Notify UI of checkpoint change
    "$dir/mcp" run "if appConsole then appConsole._checkpointsTime = 0 end" >/dev/null 2>&1
}

checkpoint_count() {
    local app="$1"
    local app_dir="$dir/apps/$app"
    local repo="$app_dir/checkpoint.fossil"

    if [ ! -f "$repo" ]; then
        echo "0"
        exit 0
    fi

    ensure_fossil
    cd "$app_dir"
    # Count commits excluding baseline and fossil artifacts
    local count=$("$FOSSIL_BIN" timeline -t ci --oneline | head -n -3 | wc -l)
    echo "$count"
}

case "$prog" in
    help | --help)
        help
        ;;
    checkpoint)
        cmd="$1"
        app="$2"
        case "$cmd" in
            save)
                checkpoint_save "$app" "$3"
                ;;
            list)
                checkpoint_list "$app"
                ;;
            rollback)
                checkpoint_rollback "$app" "$3"
                ;;
            diff)
                checkpoint_diff "$app" "$3"
                ;;
            clear)
                checkpoint_clear "$app"
                ;;
            baseline)
                checkpoint_baseline "$app"
                ;;
            count)
                checkpoint_count "$app"
                ;;
            *)
                echo "Usage: mcp checkpoint save|list|rollback|diff|clear|baseline|count APP [arg]" >&2
                exit 1
                ;;
        esac
        ;;
    audit)
        app="$1"
        if [ -z "$app" ]; then
            echo "Usage: ./audit <appname>"
            exit 1
        fi
        exec curl -s -X POST "http://127.0.0.1:$port/api/ui_audit" \
             -H "Content-Type: application/json" \
             -d "{\"name\": \"$app\"}"
        ;;
    patterns)
        patterns_dir="$dir/patterns"
        if [ ! -d "$patterns_dir" ]; then
            echo "No patterns directory"
            exit 0
        fi
        for file in "$patterns_dir"/*.md; do
            [ -e "$file" ] || continue
            # Extract frontmatter (between --- markers)
            desc=$(sed -n '/^---$/,/^---$/{ /^description:/s/^description: *//p }' "$file")
            basename="${file##*/}"
            basename="${basename%.md}"
            echo "- \`$basename.md\` - $desc"
        done
        ;;
    browser)
        exec curl -s -X POST "http://127.0.0.1:$port/api/ui_open_browser" \
             -H "Content-Type: application/json" \
             -d '{}'
        ;;
    display)
        name="${1:?Usage: display <app-name>}"
        exec curl -s -X POST "http://127.0.0.1:$port/api/ui_display" \
             -H "Content-Type: application/json" \
             -d "$(jq -n --arg name "$name" '{name: $name}')"
        ;;
    event)
        # kill previous event watcher for this config if there is one
        if [ -f "$dir/.eventpid" ]; then
            if [ "$(ps --no-headers -o comm $(cat "$dir/.eventpid"))" = bash ]; then
                kill "$dir/.eventpid"
            fi
        fi
        echo $BASHPID > "$dir/.eventpid"
        while true; do
            out="$(curl -s "http://127.0.0.1:$port/wait?timeout=120")"
            status=$?
            if [ -n "$out" ]; then
                echo "$out"
                rm "$dir/.eventpid"
                echo '{"note":"Restart the event loop in the background: .ui/mcp event"}'
                break
            elif [ $status != 0 ]; then
                rm "$dir/.eventpid"
                if [ $status = 127 ]; then
                    echo '{"note":"Event loop timed out. Restart: .ui/mcp event"}'
                else
                    echo '{"note":"Event exited with an error. Restart: .ui/mcp event"}'
                fi
                exit $status
            fi
        done
        ;;
    linkapp)
        exec "$dir/linkapp" "$@"
        ;;
    progress)
        app="${1:?Usage: progress <app> <percent> <stage>}"
        percent="${2:?Usage: progress <app> <percent> <stage>}"
        stage="${3:?Usage: progress <app> <percent> <stage>}"
        code="mcp:appProgress('$app', $percent, '$stage'); mcp:addAgentThinking('$stage')"
        exec curl -s -X POST "http://127.0.0.1:$port/api/ui_run" \
             -H "Content-Type: application/json" \
             -d "$(jq -n --arg code "$code" '{code: $code}')"
        ;;
    run)
        if [ -n "$FRICTIONLESS_MCP" ]; then
            # if being called from inside the MCP, do nothing
            exit
        fi
        code="${1:?Usage: run '<lua code>'}"
        exec curl -s -X POST "http://127.0.0.1:$port/api/ui_run" \
             -H "Content-Type: application/json" \
             -d "$(jq -n --arg code "$code" '{code: $code}')"
        ;;
    state)
        exec curl -s "http://127.0.0.1:$port/state"
        ;;
    status)
        exec curl -s "http://127.0.0.1:$port/api/ui_status"
        ;;
    theme)
        # Theme commands use CLI directly (no server needed)
        exec "$HOME/.claude/bin/frictionless" theme "$@" --dir "$dir"
        ;;
    variables)
        exec curl -s "http://127.0.0.1:$port/variables"
        ;;
    *)
        echo 1>&2 "Unknown command: $1"
        exit 1
        ;;
esac
