<template>
  <link rel="stylesheet" href="/mcp/css/shell.css">
  <link rel="stylesheet" href="/mcp/css/panel.css">
  <link rel="stylesheet" href="/mcp/css/tutorial.css">
  <link rel="stylesheet" href="/mcp/css/updates.css">
  <link rel="stylesheet" href="/mcp/css/dialog.css">

  <script>
    // Client-local wait time counter (updates every 200ms)
    (function() {
      function update() {
        const timestampEl = document.querySelector('.mcp-wait-timestamp');
        const counterEl = document.querySelector('.mcp-wait-counter');
        if (!timestampEl || !counterEl) return;

        const serverTimestamp = parseInt(timestampEl.textContent, 10) || 0;
        const elapsed = Math.floor(Date.now() / 1000) - serverTimestamp;

        // Show counter text only after 5 seconds of waiting
        counterEl.textContent = (serverTimestamp && elapsed > 5) ? elapsed : '';
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => { setInterval(update, 200); });
      } else {
        setInterval(update, 200);
      }
    })();
  </script>

  <div class="mcp-shell">
    <!-- Current app content -->
    <div class="mcp-app-container" ui-view="value"></div>

    <!-- Chat/Lua/Todo Panel -->
    <div class="mcp-chat-panel dock-panel hidden" id="mcp-chat-panel" ui-class-showing="panelShowing()">
      <div class="mcp-chat-resize-handle" id="mcp-chat-resize-handle"></div>
      <div class="mcp-bottom-panel-content">
        <!-- Variables Panel (replaces all other content) -->
        <div class="mcp-vars-panel" ui-class-hidden="notVarsPanel()">
          <div ui-view="variableBrowser"></div>
        </div>

        <!-- Todo Column -->
        <div class="mcp-todo-column" ui-class-collapsed="todosCollapsed" ui-class-hidden="isVarsPanel()">
          <div class="mcp-todo-header">
            <h4 ui-event-click="toggleTodos()">Todos</h4>
            <div class="mcp-todo-header-buttons">
              <sl-icon-button name="trash" label="Clear" ui-action="clearTodos()"></sl-icon-button>
              <sl-icon-button class="mcp-collapse-toggle" name="chevron-left" label="Collapse" ui-event-click="toggleTodos()"></sl-icon-button>
            </div>
          </div>
          <div class="mcp-todo-list" ui-view="todos?wrapper=lua.ViewList"></div>
        </div>

        <!-- Chat/Lua Column -->
        <div class="mcp-chat-lua-column" ui-class-hidden="isVarsPanel()">
          <div class="mcp-panel-header">
            <div class="mcp-panel-tabs">
              <sl-button size="small" ui-attr-variant="chatTabVariant()" ui-action="showChatPanel()">Chat</sl-button>
              <sl-button size="small" ui-attr-variant="luaTabVariant()" ui-action="showLuaPanel()">Lua</sl-button>
            </div>
            <sl-button size="small" ui-action="clearPanel()">Clear</sl-button>
          </div>

          <!-- Chat Panel Content -->
          <div class="mcp-chat-panel-content" ui-class-hidden="notChatPanel()">
            <div class="mcp-chat-messages" ui-view="messages?wrapper=lua.ViewList&scrollOnOutput"></div>
          </div>
          <div class="mcp-chat-input-area" ui-class-hidden="notChatPanel()">
            <!-- Image preview (below swoosh, above input) -->
            <div class="mcp-image-preview-row" ui-class-hidden="noImages()">
              <div ui-view="imageAttachments()?wrapper=lua.ViewList"></div>
            </div>
            <div class="mcp-chat-input-row">
              <sl-input placeholder="Ask about the selected app..." ui-value="chatInput?keypress" ui-event-keypress-enter="sendChat()"></sl-input>
              <sl-button variant="primary" ui-action="sendChat()">Send</sl-button>
            </div>
          </div>
          <!-- Image upload bridge (JS â†’ Lua) -->
          <span id="image-bridge" style="display:none" ui-value="imageUploadData?access=rw"></span>
          <span style="display:none" ui-value="processImageUpload()?priority=high"></span>

          <!-- Lua Panel Content -->
          <div class="mcp-lua-panel" ui-class-hidden="notLuaPanel()">
            <div class="mcp-lua-output" ui-view="luaOutputLines?wrapper=lua.ViewList&scrollOnOutput"></div>
            <div class="mcp-lua-input-area">
              <sl-textarea id="lua-input" rows="3" placeholder="Enter Lua code..." ui-value="luaInput?keypress" ui-event-keypress-ctrl-enter="runLua()"></sl-textarea>
              <div style="display:none" ui-code="_luaInputFocusTrigger"></div>
              <div class="mcp-lua-buttons">
                <sl-button size="small" ui-action="clearLuaOutput()">Clear</sl-button>
                <sl-button size="small" variant="primary" ui-action="runLua()">Run</sl-button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Status bar -->
    <div class="mcp-status-bar">
      <span class="mcp-status-text" ui-attr-class="statusClass" ui-value="statusLine" ui-class-hidden="isUpdating()"></span>
      <span class="mcp-status-text updating hidden" ui-class-showing="isUpdating()">
        Updating to v<span ui-value="latestVersion"></span>...
        <sl-progress-bar indeterminate></sl-progress-bar>
      </span>
      <span class="mcp-status-toggles">
        <span class="mcp-build-mode-toggle" ui-event-click="toggleVarsPanel()" title="Variables">
          <sl-icon name="braces" ui-attr-name="varsIcon()"></sl-icon>
        </span>
        <span class="mcp-build-mode-toggle" ui-html="helpLinkHtml()"></span>
        <span class="mcp-build-mode-toggle" ui-event-click="openTools()" ui-class-has-checkpoints="currentAppHasCheckpoints()" ui-attr-title="toolsTooltip()">
          <sl-icon name="tools"></sl-icon>
        </span>
        <span class="mcp-build-mode-toggle" ui-event-click="toggleBuildMode()" ui-attr-title="buildModeTooltip()">
          <sl-icon name="rocket-takeoff-fill" ui-class-hidden="isThoroughMode()"></sl-icon>
          <sl-icon name="gem" class="hidden" ui-class-showing="isThoroughMode()"></sl-icon>
        </span>
        <span class="mcp-build-mode-toggle" ui-event-click="toggleBackground()" ui-attr-title="backgroundTooltip()">
          <sl-icon name="hourglass-split" ui-class-hidden="isBackground()"></sl-icon>
          <sl-icon name="arrow-repeat" class="hidden" ui-class-showing="isBackground()"></sl-icon>
        </span>
        <span class="mcp-build-mode-toggle" ui-event-click="togglePanel()" title="Chat panel">
          <sl-icon name="chat-dots" ui-attr-name="panelIcon()"></sl-icon>
        </span>
      </span>
    </div>

    <!-- App switcher menu button -->
    <div class="mcp-menu-container">
      <button class="mcp-menu-button" ui-action="toggleMenu()" ui-class-waiting="isWaiting()" title="App Menu">
        <sl-icon class="mcp-icon" name="grid-3x3-gap-fill"></sl-icon>
        <span class="mcp-wait-counter"></span>
        <span class="mcp-wait-timestamp" style="display:none;" ui-value="waitStartOffset()"></span>
        <span style="display:none;" ui-value="checkDisconnectNotify()"></span>
      </button>
      <!-- Update available star -->
      <sl-icon class="mcp-update-star hidden" name="star-fill"
               ui-class-showing="updateAvailable()"
               ui-event-click="startUpdate()"
               title="Update available! Click to update."></sl-icon>
    </div>

    <!-- Dropdown menu with icon grid -->
    <div class="mcp-menu-dropdown hidden" ui-class-showing="menuShowing()">
      <div class="mcp-icon-grid" ui-viewlist="availableApps()" ui-namespace="list-item">
        <div></div>
      </div>
    </div>

    <!-- Notifications container -->
    <div class="mcp-notifications" ui-view="notifications()?wrapper=lua.ViewList"></div>

    <!-- Hidden element for JavaScript execution -->
    <div style="display:none;" ui-code="code"></div>

    <!-- Image preview lightbox -->
    <div id="image-lightbox" class="image-lightbox" ui-class-visible="lightboxVisible()" ui-event-click="hideLightbox()">
      <img ui-attr-src="lightboxUri" alt="Preview">
    </div>

    <!-- First-run: update preference dialog -->
    <sl-dialog label="Check for Updates?" ui-attr-open="showUpdatePrefDialog">
      <p>Would you like Frictionless to check for updates on startup?</p>
      <sl-button slot="footer" variant="default" ui-action="setUpdatePreference(false)">No</sl-button>
      <sl-button slot="footer" variant="primary" ui-action="setUpdatePreference(true)">Yes</sl-button>
    </sl-dialog>

    <!-- Update confirm dialog -->
    <sl-dialog label="Update Available" ui-attr-open="showUpdateConfirmDialog">
      <p>Version <strong ui-value="latestVersion"></strong> is available (you have <strong ui-value="currentVersion()"></strong>).</p>
      <p>Proceed with update? Claude will download and install the new version.</p>
      <sl-button slot="footer" variant="default" ui-action="cancelUpdate()">Cancel</sl-button>
      <sl-button slot="footer" variant="primary" ui-action="confirmUpdate()">Update</sl-button>
    </sl-dialog>

    <!-- Update notification -->
    <div class="mcp-update-notification hidden" ui-class-showing="showUpdateNotification()">
      <sl-alert variant="primary" open>
        <sl-icon slot="icon" name="download"></sl-icon>
        <span>Frictionless v<strong ui-value="latestVersion"></strong> is available!</span>
        <div class="update-actions">
          <sl-button size="small" variant="primary" ui-action="startUpdate()">Update</sl-button>
          <sl-button size="small" variant="default" ui-action="dismissUpdateNotification()">Later</sl-button>
        </div>
      </sl-alert>
    </div>

    <!-- Tutorial overlay (rendered by MCP.Tutorial viewdef) -->
    <div ui-view="tutorial"></div>

  </div>

  <script>
    // Image drag & drop / paste handling
    (function() {
      const panel = document.getElementById('mcp-chat-panel');
      if (!panel) return;

      let dragCounter = 0;

      panel.addEventListener('dragenter', (e) => {
        e.preventDefault();
        dragCounter++;
        panel.classList.add('drag-over');
      });

      panel.addEventListener('dragleave', (e) => {
        dragCounter--;
        if (dragCounter <= 0) {
          dragCounter = 0;
          panel.classList.remove('drag-over');
        }
      });

      panel.addEventListener('dragover', (e) => {
        e.preventDefault();
      });

      panel.addEventListener('drop', (e) => {
        e.preventDefault();
        dragCounter = 0;
        panel.classList.remove('drag-over');
        if (e.dataTransfer && e.dataTransfer.files) {
          handleImageFiles(e.dataTransfer.files);
        }
      });

      // Paste handler
      panel.addEventListener('paste', (e) => {
        const items = e.clipboardData && e.clipboardData.items;
        if (!items) return;
        const files = [];
        for (const item of items) {
          if (item.type.startsWith('image/')) {
            const file = item.getAsFile();
            if (file) files.push(file);
          }
        }
        if (files.length > 0) handleImageFiles(files);
      });

      function handleImageFiles(files) {
        for (const file of files) {
          if (!file.type.startsWith('image/')) continue;
          const reader = new FileReader();
          reader.onload = (e) => {
            const dataUri = e.target.result;
            const base64Data = dataUri.split(',')[1];
            generateThumbnail(dataUri, 150).then((thumbnail) => {
              const payload = JSON.stringify({
                filename: file.name || 'image.png',
                mime: file.type,
                base64: base64Data,
                thumbnail: thumbnail,
                fullUri: dataUri
              });
              const tryUpdate = () => {
                if (window.uiApp) {
                  window.uiApp.updateValue('image-bridge', payload);
                } else {
                  setTimeout(tryUpdate, 50);
                }
              };
              tryUpdate();
            });
          };
          reader.readAsDataURL(file);
        }
      }

      function generateThumbnail(dataUri, maxDim) {
        return new Promise((resolve) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let w = img.width, h = img.height;
            if (w > maxDim || h > maxDim) {
              if (w > h) { h = Math.round(h * maxDim / w); w = maxDim; }
              else { w = Math.round(w * maxDim / h); h = maxDim; }
            }
            canvas.width = w;
            canvas.height = h;
            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
            resolve(canvas.toDataURL('image/jpeg', 0.7));
          };
          img.onerror = () => resolve('');
          img.src = dataUri;
        });
      }
    })();
  </script>

  <script>
    // Chat panel resize handle (timer-loop drag)
    // See .ui/patterns/event-compression.md
    (function() {
      const panel = document.getElementById('mcp-chat-panel');
      const handle = document.getElementById('mcp-chat-resize-handle');
      if (!panel || !handle) return;

      let startY, startHeight, currentY, lastY, rafId;

      handle.addEventListener('mousedown', (e) => {
        startY = currentY = lastY = e.clientY;
        startHeight = panel.offsetHeight;
        panel.querySelectorAll('iframe').forEach(f => f.style.pointerEvents = 'none');
        document.addEventListener('mousemove', onDrag);
        document.addEventListener('mouseup', onRelease);
        rafLoop();
        e.preventDefault();
      });

      function onDrag(e) {
        currentY = e.clientY;
      }

      function rafLoop() {
        rafId = requestAnimationFrame(() => {
          if (currentY !== lastY) {
            lastY = currentY;
            const height = Math.max(120, Math.min(window.innerHeight * 0.6, startHeight + (startY - currentY)));
            panel.style.height = height + 'px';
          }
          rafLoop();
        });
      }

      function onRelease() {
        cancelAnimationFrame(rafId);
        document.removeEventListener('mousemove', onDrag);
        document.removeEventListener('mouseup', onRelease);
        panel.querySelectorAll('iframe').forEach(f => f.style.pointerEvents = '');
      }
    })();
  </script>


  <script>
    // Close lightbox on Escape key
    (function() {
      document.addEventListener('keydown', (e) => {
        const lightbox = document.getElementById('image-lightbox');
        if (e.key === 'Escape' && lightbox && lightbox.classList.contains('visible')) {
          // Trigger the hideLightbox() binding by clicking the overlay
          lightbox.click();
        }
      });
    })();
  </script>
</template>
