# Traceability Map

## Level 1 <-> Level 2 (Specs to Design Models)

### mcp.md

**CRC Cards:**
- crc-MCPServer.md
- crc-MCPResource.md
- crc-MCPTool.md

**Sequence Diagrams:**
- seq-mcp-lifecycle.md
- seq-mcp-create-session.md
- seq-mcp-create-presenter.md
- seq-mcp-receive-event.md
- seq-mcp-run.md
- seq-mcp-get-state.md
- seq-mcp-notify.md

**Test Design:**
- test-MCP.md

### prompt-ui.md

**CRC Cards:**
- crc-PromptManager.md
- crc-PromptHTTPServer.md
- crc-Server.md
- crc-PromptResponseCallback.md
- crc-Prompt.md (Lua model)
- crc-PromptOption.md (Lua model)
- crc-PromptViewdef.md
- crc-PermissionHook.md
- crc-HookCLI.md
- crc-ViewdefsResource.md
- crc-PermissionHistoryResource.md

**Sequence Diagrams:**
- seq-prompt-flow.md
- seq-prompt-server-startup.md
- seq-hook-install.md

**UI Specs:**
- ui-prompt-modal.md

**Test Design:**
- test-Prompt.md

---

## Level 2 <-> Level 3 (Design Models to Implementation)

*Implementation checkboxes updated to reflect actual code*

### crc-MCPServer.md
**Source Spec:** mcp.md
**Implementation:**
- [x] `internal/mcp/server.go` - MCP server (Lifecycle FSM, configuration, startup, notifications)
  - [x] SendNotification() wired to Lua mcp.notify() -> seq-mcp-notify.md
  - [x] getSessionCount callback for ui_status

### crc-MCPResource.md
**Source Spec:** mcp.md
**Implementation:**
- [ ] `internal/mcp/resources.go` - MCP resources (State root redirection via mcp.state, static resources from baseDir/resources)

### crc-MCPTool.md
**Source Spec:** mcp.md
**Implementation:**
- [x] `internal/mcp/tools.go` - MCP tools (configure, start, run, upload_viewdef, open_browser, status)
  - [x] handleStatus() for ui_status tool

### crc-PromptManager.md
**Source Spec:** prompt-ui.md
**Implementation:**
- [ ] `internal/prompt/manager.go` - Prompt manager (pending prompts, channels, timeout)

### crc-PromptHTTPServer.md
**Source Spec:** prompt-ui.md
**Implementation:**
- [ ] `internal/prompt/server.go` - HTTP server (POST /api/prompt, port file)

### crc-Server.md
**Source Spec:** prompt-ui.md
**Implementation:**
- [ ] `internal/prompt/prompt.go` - Server.Prompt() method extension

### crc-PromptResponseCallback.md
**Source Spec:** prompt-ui.md
**Implementation:**
- [ ] `internal/prompt/callback.go` - _G.promptResponse Lua callback

### crc-PromptViewdef.md
**Source Spec:** prompt-ui.md
**Implementation:**
- [x] `web/viewdefs/Prompt.DEFAULT.html` - Prompt dialog viewdef

### crc-Prompt.md
**Source Spec:** prompt-ui.md
**Implementation:**
- [x] `web/lua/prompt.lua` - Prompt Lua model with prototype pattern

### crc-PromptOption.md
**Source Spec:** prompt-ui.md
**Implementation:**
- [x] `web/lua/prompt.lua` - PromptOption Lua model with respond() method

### crc-PermissionHook.md
**Source Spec:** prompt-ui.md
**Implementation:**
- [ ] `.claude/hooks/permission-ui.sh` - Hook script (generated by HookCLI)

### crc-HookCLI.md
**Source Spec:** prompt-ui.md
**Implementation:**
- [ ] `cmd/hooks.go` - hooks install/uninstall/status subcommands

### crc-ViewdefsResource.md
**Source Spec:** prompt-ui.md
**Implementation:**
- [ ] `internal/mcp/resources.go` - ui://viewdefs resource

### crc-PermissionHistoryResource.md
**Source Spec:** prompt-ui.md
**Implementation:**
- [ ] `internal/mcp/resources.go` - ui://permissions/history resource

---

## Integration with ui-engine

The MCP implementation integrates with ui-engine components:

**Session Management:**
- Uses ui-engine's Session and SessionManager for session lifecycle
- Creates backends via ui-engine's LuaBackend

**Lua Runtime:**
- Uses ui-engine's LuaRuntime for Lua code execution
- Exposes `mcp.state` and `mcp.notify` globals
- Registers `_G.promptResponse` callback for prompt responses

**Variable Protocol:**
- Accesses state through ui-engine's VariableStore
- Uses ui-engine's ProtocolHandler for message processing

**Viewdef System:**
- Uses ui-engine's viewdef system for Prompt.DEFAULT rendering
- Presenter switching via app._presenter triggers viewdef change

---

## External Dependencies

**ui-engine project:**
- Session management (`internal/session/`)
- Lua runtime (`internal/lua/`)
- Variable protocol (`internal/variable/`, `internal/protocol/`)
- Viewdef system (`internal/viewdef/`)

**MCP SDK:**
- Model Context Protocol implementation
- Tool and resource registration
