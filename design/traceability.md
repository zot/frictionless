# Traceability Map

## Level 1 <-> Level 2 (Specs to Design Models)

### mcp.md

**CRC Cards:**
- crc-MCPServer.md
- crc-MCPResource.md
- crc-MCPTool.md

**Sequence Diagrams:**
- seq-mcp-lifecycle.md
- seq-mcp-create-session.md
- seq-mcp-create-presenter.md
- seq-mcp-receive-event.md
- seq-mcp-run.md
- seq-mcp-get-state.md
- seq-mcp-notify.md

**Test Design:**
- test-MCP.md

### prompt-ui.md

**CRC Cards:**
- crc-PromptManager.md
- crc-PromptHTTPServer.md
- crc-Server.md
- crc-PromptResponseCallback.md
- crc-Prompt.md (Lua model)
- crc-PromptOption.md (Lua model)
- crc-PromptViewdef.md
- crc-PermissionHook.md
- crc-HookCLI.md
- crc-ViewdefsResource.md
- crc-PermissionHistoryResource.md

**Sequence Diagrams:**
- seq-prompt-flow.md
- seq-prompt-server-startup.md
- seq-hook-install.md

**UI Specs:**
- ui-prompt-modal.md

**Test Design:**
- test-Prompt.md

---

## Level 2 <-> Level 3 (Design Models to Implementation)

*Implementation checkboxes updated to reflect actual code*

### crc-MCPServer.md
**Source Spec:** mcp.md
**Implementation:**
- [x] `internal/mcp/server.go` - MCP server (Lifecycle FSM, configuration, startup, notifications)
  - [x] Configure() -> seq-mcp-lifecycle.md
  - [x] Start() -> seq-mcp-lifecycle.md
  - [x] Stop() - session restart support (159bc52)
  - [x] SendNotification() wired to Lua mcp.notify() -> seq-mcp-notify.md
  - [x] getSessionCount callback for ui_status
  - [x] ServeSSE() - SSE transport mode (5a11c38)
  - [x] handleDebugVariables() - debug endpoint
  - [x] handleDebugState() - debug endpoint
  - [x] StartPromptServer() - prompt API server
  - [x] handlePrompt() -> seq-prompt-flow.md

### crc-MCPResource.md
**Source Spec:** mcp.md
**Implementation:**
- [x] `internal/mcp/resources.go` - MCP resources
  - [x] handleGetStateResource() - ui://state
  - [x] handleGetVariablesResource() - ui://variables
  - [x] handleGetStaticResource() - ui://{path}
  - [x] handleGetPromptViewdefsResource() - ui://prompt/viewdefs
  - [x] handleGetPermissionsHistoryResource() - ui://permissions/history

### crc-MCPTool.md
**Source Spec:** mcp.md
**Implementation:**
- [x] `internal/mcp/tools.go` - MCP tools
  - [x] handleConfigure() -> seq-mcp-lifecycle.md
    - [x] Directory creation
    - [x] Lua I/O redirection
    - [x] Resource extraction
    - [x] Agent file installation -> seq-mcp-lifecycle.md (Scenario 1a)
  - [x] handleStart() -> seq-mcp-lifecycle.md
  - [x] handleRun() -> seq-mcp-run.md (browser update trigger - ccbbf4f)
  - [x] handleUploadViewdef()
  - [x] handleOpenBrowser()
  - [x] handleStatus()

### crc-PromptManager.md
**Source Spec:** prompt-ui.md
**Implementation:**
- [x] `internal/mcp/prompt.go` - Prompt manager (pending prompts, channels, timeout)
  - [x] Prompt() - create prompt and wait for response
  - [x] Respond() - receive response from Lua callback
  - [x] setPromptInLua() - set mcp.value with prompt data
  - [x] clearPromptInLua() - clear prompt on timeout

### crc-PromptHTTPServer.md
**Source Spec:** prompt-ui.md
**Implementation:**
- [x] `internal/mcp/server.go` - HTTP server integrated into MCPServer
  - [x] StartPromptServer() - start background HTTP server
  - [x] WritePortFile() - write port to mcp-port file
  - [x] handlePrompt() - POST /api/prompt endpoint

### crc-Server.md
**Source Spec:** prompt-ui.md
**Implementation:**
- [x] `internal/mcp/server.go` - Prompt functionality in MCPServer
  - [x] promptManager field
  - [x] handlePrompt() calls promptManager.Prompt()

### crc-PromptResponseCallback.md
**Source Spec:** prompt-ui.md
**Implementation:**
- [x] `internal/mcp/tools.go` - mcp.promptResponse() registered in setupMCPGlobal()
  - [x] Lua callback calls promptManager.Respond()

### crc-PromptViewdef.md
**Source Spec:** prompt-ui.md
**Implementation:**
- [x] `web/viewdefs/MCP.DEFAULT.html` - MCP viewdef with prompt dialog
- [x] `web/viewdefs/PromptOption.DEFAULT.html` - Option button viewdef

### crc-Prompt.md
**Source Spec:** prompt-ui.md
**Implementation:**
- [x] `internal/mcp/prompt.go` - Prompt data set via setPromptInLua()
  - Note: Prompt is created inline in Lua, not via separate Lua model file

### crc-PromptOption.md
**Source Spec:** prompt-ui.md
**Implementation:**
- [x] `web/viewdefs/PromptOption.DEFAULT.html` - PromptOption viewdef with respond()
- [x] `internal/mcp/prompt.go` - Options with respond() method created in setPromptInLua()

### crc-PermissionHook.md
**Source Spec:** prompt-ui.md
**Implementation:**
- [x] `cmd/ui-mcp/main.go` - Hook script embedded as hookScript constant
  - [x] Generated by installHook() function

### crc-HookCLI.md
**Source Spec:** prompt-ui.md
**Implementation:**
- [x] `cmd/ui-mcp/main.go` - hooks command integrated into main
  - [x] runHooks() - dispatch to subcommands
  - [x] installHook() - create script and update settings
  - [x] uninstallHook() - remove from settings
  - [x] hookStatus() - check installation state

### crc-ViewdefsResource.md
**Source Spec:** prompt-ui.md
**Implementation:**
- [x] `internal/mcp/resources.go` - ui://prompt/viewdefs resource
  - [x] handleGetPromptViewdefsResource()

### crc-PermissionHistoryResource.md
**Source Spec:** prompt-ui.md
**Implementation:**
- [x] `internal/mcp/resources.go` - ui://permissions/history resource
  - [x] handleGetPermissionsHistoryResource()

---

## Integration with ui-engine

The MCP implementation integrates with ui-engine components:

**Session Management:**
- Uses ui-engine's Session and SessionManager for session lifecycle
- Creates backends via ui-engine's LuaBackend

**Lua Runtime:**
- Uses ui-engine's LuaRuntime for Lua code execution
- Exposes `mcp.state` and `mcp.notify` globals
- Registers `_G.promptResponse` callback for prompt responses

**Variable Protocol:**
- Accesses state through ui-engine's VariableStore
- Uses ui-engine's ProtocolHandler for message processing

**Viewdef System:**
- Uses ui-engine's viewdef system for Prompt.DEFAULT rendering
- Presenter switching via app._presenter triggers viewdef change

---

## External Dependencies

**ui-engine project:**
- Session management (`internal/session/`)
- Lua runtime (`internal/lua/`)
- Variable protocol (`internal/variable/`, `internal/protocol/`)
- Viewdef system (`internal/viewdef/`)

**MCP SDK:**
- Model Context Protocol implementation
- Tool and resource registration
